<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsOrder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #f5f5f5;
            color: #333333 !important;
        }

        /* Force light theme styles */
        * {
            color: #333333 !important;
            background-color: transparent !important;
        }

        iframe {
            background: white !important;
        }
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            background: #ffffff;
            color: #000000;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25D366;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h2 {
            color: #25D366;
            margin: 10px 0;
        }
        p {
            color: #666666;
        }
        #webview-frame {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
            background: white;
            color-scheme: light;
        }

        /* Force light theme on iframe content */
        #webview-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            pointer-events: none;
            z-index: -1;
        }
        #error-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: #ffffff;
        }
        .retry-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        .retry-btn:hover {
            background: #1da851;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <h2>WhatsOrder</h2>
        <p>Loading your app... (v1.1)</p>
    </div>

    <div id="error-container">
        <h2>Connection Error</h2>
        <p>Unable to load the app. Please check your internet connection.</p>
        <button class="retry-btn" onclick="retryLoad()">Retry</button>
    </div>

    <iframe id="webview-frame" src="https://whats-order-osr3.vercel.app"></iframe>

    <script>
        let loadTimeout;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');

            // Set a timeout for loading
            loadTimeout = setTimeout(() => {
                console.log('Load timeout reached');
                showError();
            }, 10000);

            // Initialize the iframe and native functions
            initializeApp();
        });

        function initializeApp() {
            const iframe = document.getElementById('webview-frame');

            // Initialize native functions immediately
            initializeNativeFunctions();
            initializeAdMob();
            setupExternalLinkHandling();

            // Handle successful load
            iframe.onload = function() {
                console.log('Iframe loaded successfully');
                clearTimeout(loadTimeout);

                // Force light theme in iframe
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const style = iframeDoc.createElement('style');
                    style.textContent = `
                        * { 
                            color: #333333 !important; 
                            background-color: white !important; 
                        }
                        body { 
                            background: white !important; 
                            color: #333333 !important; 
                        }
                        .dark, [data-theme="dark"] { 
                            background: white !important; 
                            color: #333333 !important; 
                        }
                    `;
                    iframeDoc.head.appendChild(style);
                } catch (e) {
                    console.log('Could not inject theme styles:', e);
                }

                showSuccess();
            };

            // Handle load error
            iframe.onerror = function() {
                console.log('Iframe load error');
                clearTimeout(loadTimeout);
                showError();
            };

            // Fallback - show iframe after minimum loading time even if onload doesn't fire
            setTimeout(() => {
                console.log('Fallback timer - showing iframe');
                clearTimeout(loadTimeout);
                showSuccess();
            }, 5000);
        }

        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
            document.getElementById('webview-frame').style.display = 'block';
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('webview-frame').style.display = 'none';
            document.getElementById('error-container').style.display = 'flex';
        }

        function retryLoad() {
            document.getElementById('error-container').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';

            const iframe = document.getElementById('webview-frame');
            iframe.src = iframe.src;

            loadTimeout = setTimeout(showError, 15000);
        }

        function initializeNativeFunctions() {
            console.log('Initializing native functions...');

            // Make native functions available globally for the web app
            window.nativeGoogleAuth = {
                signIn: async () => {
                    try {
                        if (window.Capacitor && window.Capacitor.Plugins.GoogleAuth) {
                            const result = await window.Capacitor.Plugins.GoogleAuth.signIn();
                            return result;
                        } else {
                            throw new Error('Google Auth plugin not available');
                        }
                    } catch (error) {
                        console.error('Google Sign In Error:', error);
                        throw error;
                    }
                },
                signOut: async () => {
                    try {
                        if (window.Capacitor && window.Capacitor.Plugins.GoogleAuth) {
                            await window.Capacitor.Plugins.GoogleAuth.signOut();
                        }
                    } catch (error) {
                        console.error('Google Sign Out Error:', error);
                        throw error;
                    }
                }
            };

            window.nativeCamera = {
                takePicture: async () => {
                    try {
                        if (window.Capacitor && window.Capacitor.Plugins.Camera) {
                            const image = await window.Capacitor.Plugins.Camera.getPhoto({
                                quality: 90,
                                allowEditing: true,
                                resultType: 'DataUrl',
                                source: 'Camera'
                            });
                            return image.dataUrl;
                        } else {
                            throw new Error('Camera plugin not available');
                        }
                    } catch (error) {
                        console.error('Camera Error:', error);
                        throw error;
                    }
                },
                selectFromGallery: async () => {
                    try {
                        if (window.Capacitor && window.Capacitor.Plugins.Camera) {
                            const image = await window.Capacitor.Plugins.Camera.getPhoto({
                                quality: 90,
                                allowEditing: true,
                                resultType: 'DataUrl',
                                source: 'Photos'
                            });
                            return image.dataUrl;
                        } else {
                            throw new Error('Camera plugin not available');
                        }
                    } catch (error) {
                        console.error('Gallery Error:', error);
                        throw error;
                    }
                }
            };

            // Add external URL handling for WhatsApp, phone calls, etc.
            window.openExternalUrl = async (url) => {
                try {
                    if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                        // For native environment, try Browser plugin first
                        if (window.Capacitor.Plugins.Browser) {
                            await window.Capacitor.Plugins.Browser.open({
                                url: url,
                                presentationStyle: 'fullscreen'
                            });
                        } else {
                            // Use native app intent for WhatsApp, phone, etc.
                            window.open(url, '_system');
                        }
                    } else {
                        // Fallback for web browser testing
                        window.open(url, '_blank');
                    }
                } catch (error) {
                    console.error('Error opening external URL:', error);
                    // Final fallback - use system browser
                    try {
                        window.open(url, '_system');
                    } catch (e) {
                        window.open(url, '_blank');
                    }
                }
            };

            console.log('Native functions initialized');
        }

        // AdMob Integration
        function initializeAdMob() {
            console.log('Initializing AdMob...');

            // Check if we're in a native environment
            if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                const AdMob = window.Capacitor.Plugins.AdMob;

                if (AdMob) {
                    // Create ad functions first
                    window.showBannerAd = async () => {
                        try {
                            await AdMob.showBanner({
                                adId: 'ca-app-pub-5538218540896625/8498698237',
                                adSize: 'BANNER',
                                position: 'BOTTOM_CENTER',
                                margin: 0,
                                isTesting: false
                            });
                            console.log('Banner ad shown');
                        } catch (error) {
                            console.error('Banner ad error:', error);
                        }
                    };

                    window.hideBannerAd = async () => {
                        try {
                            await AdMob.hideBanner();
                            console.log('Banner ad hidden');
                        } catch (error) {
                            console.error('Hide banner error:', error);
                        }
                    };

                    window.prepareInterstitialAd = async () => {
                        try {
                            await AdMob.prepareInterstitial({
                                adId: 'ca-app-pub-5538218540896625/8673958054',
                                isTesting: false
                            });
                            console.log('Interstitial ad prepared');
                        } catch (error) {
                            console.error('Prepare interstitial error:', error);
                        }
                    };

                    window.showInterstitialAd = async () => {
                        try {
                            await AdMob.showInterstitial();
                            console.log('Interstitial ad shown');
                            // Prepare the next interstitial ad
                            setTimeout(() => window.prepareInterstitialAd(), 1000);
                        } catch (error) {
                            console.error('Show interstitial error:', error);
                        }
                    };

                    // Initialize AdMob
                    AdMob.initialize({
                        requestTrackingAuthorization: true,
                        testingDevices: [],
                        initializeForTesting: false
                    }).then(() => {
                        console.log('AdMob initialized successfully');

                        // Show banner ad after initialization
                        setTimeout(() => {
                            window.showBannerAd();
                        }, 3000);

                        // Prepare interstitial ad
                        setTimeout(() => {
                            window.prepareInterstitialAd();
                        }, 1000);
                    }).catch(error => {
                        console.error('AdMob initialization error:', error);
                    });
                } else {
                    console.log('AdMob plugin not found');
                }
            } else {
                console.log('Not in native environment, skipping AdMob');

                // Create dummy functions for web testing
                window.showBannerAd = () => console.log('Banner ad (web)');
                window.hideBannerAd = () => console.log('Hide banner (web)');
                window.prepareInterstitialAd = () => console.log('Prepare interstitial (web)');
                window.showInterstitialAd = () => console.log('Show interstitial (web)');
            }
        }

        // Setup external link handling
        function setupExternalLinkHandling() {
            console.log('Setting up external link handling...');

            // Listen for messages from the iframe
            window.addEventListener('message', function(event) {
                if (event.origin !== 'https://whats-order-osr3.vercel.app') {
                    return;
                }

                if (event.data.type === 'OPEN_EXTERNAL_URL') {
                    const url = event.data.url;
                    if (url && window.Capacitor && window.Capacitor.isNativePlatform()) {
                        // Use Capacitor's Browser plugin or native method
                        window.open(url, '_blank');
                    }
                } else if (event.data.type === 'SHOW_INTERSTITIAL_AD') {
                    // Trigger interstitial ad from web content
                    window.showInterstitialAd();
                }
            });

            console.log('External link handling setup complete');
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsOrder - Crashlytics Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .crash-btn {
            background-color: #ff4757;
            color: white;
        }
        .crash-btn:hover {
            background-color: #ff3838;
        }
        .auth-btn {
            background-color: #4285f4;
            color: white;
        }
        .auth-btn:hover {
            background-color: #3367d6;
        }
        .log-btn {
            background-color: #26de81;
            color: white;
        }
        .log-btn:hover {
            background-color: #20bf6b;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WhatsOrder</h1>
        <p>Crashlytics Test Interface</p>
        
        <button id="testCrashBtn" class="crash-btn">
            🔥 Test Crash (Crashlytics Setup)
        </button>
        
        <button id="googleSignInBtn" class="auth-btn">
            📱 Test Google Sign In
        </button>
        
        <button id="logEventBtn" class="log-btn">
            📝 Log Test Event
        </button>
        
        <div id="status" class="status"></div>
        
        <div style="margin-top: 30px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px;">
            <h3>🚨 Testing Instructions:</h3>
            <ol>
                <li>Click "Test Crash" to verify Crashlytics setup</li>
                <li>App will crash - restart it manually</li>
                <li>Check Firebase Console for crash report</li>
                <li>Test other features to generate breadcrumbs</li>
            </ol>
        </div>
    </div>

    <script type="module">
        import { testCrash, recordBreadcrumb, logEvent, recordException } from './src/crashlytics.js';
        import { signInWithGoogle } from './src/google-auth.js';

        const statusDiv = document.getElementById('status');

        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${isError ? 'error' : 'success'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Test crash button
        document.getElementById('testCrashBtn').addEventListener('click', async () => {
            try {
                await recordBreadcrumb('User clicked Test Crash button', 'testing');
                showStatus('Forcing test crash... App will restart');
                
                // Small delay to show the message
                setTimeout(async () => {
                    await testCrash();
                }, 1000);
            } catch (error) {
                showStatus('Test crash failed: ' + error.message, true);
            }
        });

        // Google Sign In button
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            try {
                await recordBreadcrumb('User clicked Google Sign In test button', 'testing');
                const result = await signInWithGoogle();
                showStatus('Google Sign In successful!');
                console.log('Sign in result:', result);
            } catch (error) {
                showStatus('Google Sign In failed: ' + error.message, true);
                await recordException(error);
            }
        });

        // Log event button
        document.getElementById('logEventBtn').addEventListener('click', async () => {
            try {
                await recordBreadcrumb('User clicked Log Event test button', 'testing');
                await logEvent('Test event logged from UI');
                showStatus('Test event logged successfully!');
            } catch (error) {
                showStatus('Failed to log event: ' + error.message, true);
                await recordException(error);
            }
        });

        // Log app startup
        window.addEventListener('load', async () => {
            try {
                await recordBreadcrumb('App loaded successfully', 'app_lifecycle');
                await logEvent('App startup completed');
            } catch (error) {
                console.error('Failed to log startup:', error);
            }
        });
    </script>
</body>
</html>
